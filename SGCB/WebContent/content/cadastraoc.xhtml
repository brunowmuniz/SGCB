<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

	<ui:composition template="../template/template.xhtml">
		<ui:define name="conteudo">			
			<h:form id="form">
				<p:panel header="Cadastro de OC">
					<p:messages id="msgs"/>					
					<h:panelGrid id="cadastro" columns="3" width="900px;">
						
						<h:panelGrid columns="2" styleClass="vAlTop" style="width: 350px">
							<p:outputLabel for="numero" value="Número OC:"/>
							<h:outputText value="#{ocControl.oc.id == null ? 'Nova OC' : ocControl.oc.id}"  id="numero" style="width: 100px; " styleClass="negrito" update="cadastro"/>
							
							<p:outputLabel for="filialoc" value="Filial: "/>
							<p:selectOneMenu value="#{ocControl.oc.filial.id}" size="1" id="filialoc" required="#{ocControl.oc.id == null}"
											 requiredMessage="Favor selecionar a filial" rendered="#{ocControl.oc.id == null}">
								<f:selectItem itemLabel="Selecione a filial" itemValue="" noSelectionOption="true"/>
								<f:selectItems value="#{filialControl.listaFilialCombo}"/>
								<p:ajax event="change" update="vendedor"/>
							</p:selectOneMenu>
							<h:outputText value="#{ocControl.oc.filial.nome}" rendered="#{ocControl.oc.id != null}" styleClass="negrito"/>
							
							<p:outputLabel for="#{ocControl.oc.id == null ? 'dataedicao' : 'data'}" value="Data: "/>
							<h:outputText value="#{ocControl.oc.datalancamento}" id="dataedicao" style="width: 100px;" styleClass="negrito"
											rendered="#{ocControl.oc.id != null}">									
								<f:convertDateTime pattern="dd/MM/yyyy"/>									
							</h:outputText>							
							<p:calendar value="#{ocControl.oc.datalancamento}" id="data" pattern="dd/MM/yyyy" locale="pt" rendered="#{ocControl.oc.id == null}" />									
						</h:panelGrid>
						
						<h:panelGrid columns="2" styleClass="vAlTop" style="width: 350px">
							<p:outputLabel for="status" value="Status OC:"/>
							<h:outputText value="#{ocControl.oc.status.descricao}" id="status" styleClass="negrito status_#{ocControl.oc.status.id}"/>
							
							<p:outputLabel for="vendedor" value="Vendedor: "/>
							<p:selectOneMenu id="vendedor" value="#{ocControl.oc.usuario.id}" size="1" rendered="#{ocControl.oc.id == null}" disabled="#{ocControl.oc.filial.id == null}">
								<f:selectItem itemLabel="Selecione Vendedor" itemValue="" noSelectionOption="true"/>
								<f:selectItems value="#{usuarioControl.getListaVendedorFilial(ocControl.oc.filial)}"/>
							</p:selectOneMenu>							
							<h:outputText value="#{ocControl.oc.usuario.nome}" rendered="#{ocControl.oc.id != null}" styleClass="negrito"/>		
						</h:panelGrid>
						
						<h:panelGrid columns="1" styleClass="vAlTop" style="width: 200px">
							<p:commandButton value="Gravar OC" action="#{ocControl.gravar}" ajax="false" rendered="#{ocControl.oc.id == null}"/>
														
							<p:commandButton value="Alterar OC" action="#{ocControl.alterar}" ajax="false" rendered="#{ocControl.oc.id != null and (ocControl.oc.status.id == 1 or ocControl.oc.status.id == 2 or ocControl.oc.status.id == 7)}"/>
							
							<p:commandButton value="Estornar OC" action="#{ocControl.estornar}" ajax="false" 
											rendered="#{ocControl.oc.id != null and (ocControl.oc.status.id != 1 and ocControl.oc.status.id != 2 
															and ocControl.oc.status.id != 9 and ocControl.oc.status.id != 10)}"/>		
						</h:panelGrid>
							
														
						</h:panelGrid>
						<p:tabView id="oc">																																							 
							<p:tab title="Dados do Cliente">								
								<h:panelGrid id="dadoscliente">
									<h:panelGrid columns="3">
										<p:outputLabel for="buscarcliente" value="Busca Cliente: "/>
										<p:autoComplete id="buscarcliente" value="#{ocControl.oc.cliente}" minQueryLength="3"
															completeMethod="#{clienteControl.listaComplete}"											 
															forceSelection="true" converter="converter.clienteConverter"
															var="cliente" itemValue="#{cliente}" itemLabel="#{cliente.nome}"
															disabled="#{ocControl.oc.cliente.id != null}">
												<p:ajax event="itemSelect" update="dadoscliente,occliente" process="@this"/>
										</p:autoComplete>
										<p:commandButton value="Limpar" actionListener="#{ocControl.limparCliente}" update="dadoscliente" id="limparcliente" rendered="#{ocControl.oc.cliente.id != null}" process="@this" />
									</h:panelGrid>
									<h:panelGrid columns="2">
										<p:outputLabel value="Nome: " for="nomeclienteoc"/>
										<p:inputText size="78" value="#{ocControl.oc.cliente.nome}" required="true" id="nomeclienteoc">
											<f:validateBean />
										</p:inputText>
										
										<p:outputLabel value="Endereço: " for="enderecoclienteoc"/>
										<p:inputText size="78" value="#{ocControl.oc.cliente.endereco}" required="true" id="enderecoclienteoc">
											<f:validateBean/>
										</p:inputText>
									</h:panelGrid>
									<h:panelGrid columns="4">	
										<p:outputLabel value="Cidade: " for="cidadeclienteoc"/>
										<p:inputText size="30" value="#{ocControl.oc.cliente.cidade}" required="true" id="cidadeclienteoc">
											<f:validateBean/>
										</p:inputText>
										
										<p:outputLabel value="Telefone: " for="telefoneclienteoc"/>
										<p:inputMask size="30" value="#{ocControl.oc.cliente.telefone}" required="true" id="telefoneclienteoc" mask="(99) 9999-9999">
											<f:validateBean/>
										</p:inputMask>
										
										<p:outputLabel value="CPF: " for="cpfclienteoc"/>
										<p:inputMask size="30" value="#{ocControl.oc.cliente.cpf}" required="true" id="cpfclienteoc" mask="999.999.999-99" />
										
										<p:outputLabel value="RG: " for="rgclienteoc"/>
										<p:inputText size="30" value="#{ocControl.oc.cliente.rg}" required="true" id="rgclienteoc"/>
										
										<p:outputLabel value="Data Nascimento: " for="datanascimentoclienteoc"/>
										<p:inputMask size="30" value="#{ocControl.oc.cliente.datadenascimento}" required="true" id="datanascimentoclienteoc"
											mask="99/99/9999">
											<f:convertDateTime pattern="dd/MM/yyyy"/>
										</p:inputMask>								
									</h:panelGrid>
								</h:panelGrid>
								
								<p:outputPanel autoUpdate="true" id="occliente">
									<p:dataTable value="#{ocControl.oc.cliente.ocs}" var="oc" rendered="#{ocControl.oc.id == null and ocControl.oc.cliente.id != null}"
									 	 rowKey="#{oc.id}" emptyMessage="Sem compras anteriores para este cliente!" rows="10" style="width:40%;">														
										
										<f:facet name="header">
											Compras anteriores do cliente
										</f:facet>
										
										<p:column headerText="Nº">
										<h:outputText value="#{oc.id}" />
										</p:column>
										<p:column headerText="Status" styleClass="status_#{oc.status.id}">
											<h:outputText value="#{oc.status.descricao}"/>
										</p:column>
										<p:column headerText="Data">
											<h:outputText value="#{oc.datalancamento}">
												<f:convertDateTime pattern="dd/MM/yyyy" locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column headerText="Valor">
											<h:outputText value="R$ " />
											<h:outputText value="#{oc.valorfinal}">
												<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
											</h:outputText>
										</p:column>														
									</p:dataTable>
								</p:outputPanel>
							</p:tab>
							<p:tab title="Produtos" id="tabProdutos">
								<p:commandButton value="Procurar Produto" id="btnbuscaproduto" oncomplete="modalbuscaproduto.show()" action="#{ocProdutoControl.limparOcProduto}" actionListener="#{ocProdutoControl.limparProduto}" update="modalbuscaproduto" process="@this"
												rendered="#{ocControl.oc.status.id == 2 or ocControl.oc.status.id == 1 or ocControl.oc.id == null}"/> <br />
								
								<p:commandButton value="Encerrar Produto" id="encerrarAcao" actionListener="#{ocControl.acaoProduto(9,freteControl.listaMontadores)}" update=":form:msgs,listaprodutoocfechada" rendered="#{ocControl.oc.status.id != 2 and ocControl.oc.status.id != 1 and ocControl.oc.id != null}"/>
								 
								<p:commandButton value="Assistência Técnica" id="assistTecAcao" onclick="modalAssistenciaTecnica.show()"  rendered="#{ocControl.oc.status.id != 2 and ocControl.oc.status.id != 1 and ocControl.oc.id != null}"/>
								
								<p:commandButton value="Frete/Execução" id="freteExecAcao" onclick="modalFreteMontagem.show()" rendered="#{ocControl.oc.status.id != 2 and ocControl.oc.status.id != 1 and ocControl.oc.id != null}"/>
								
								<p:spacer width="10px"/>
														
								<p:dialog widgetVar="modalFreteMontagem" id="modalFreteMontagem" resizable="false" header="Montadores">
									<p:outputPanel id="updMontagemFrete" autoUpdate="true">
										<h:panelGrid columns="2">
											<p:outputLabel for="listaMontadores" value="Montador"/>
											<p:selectManyMenu value="#{freteControl.listaMontadores}" id="listaMontadores">
												<f:selectItem itemValue="" noSelectionOption="true"/>
												<f:selectItems value="#{usuarioControl.listaUsuarioMontador}" />
												<p:ajax event="change" process="@this" update="freteExecucaoAcao,listaMontadores"/> 
											</p:selectManyMenu>
											<p:outputLabel value="Observações: " for="observacoesfretemontagem"/>
											<p:inputTextarea id="observacoesfretemontagem" value="#{ocControl.observacoesFreteMontAT}" cols="20" rows="5" maxlength="100"/>
											<p:commandButton actionListener="#{ocControl.acaoProduto(6,freteControl.listaMontadores)}" oncomplete="modalFreteMontagem.hide()" id="freteExecucaoAcao" value="Gravar Frete/Execução" disabled="#{freteControl.listaMontadores.size() == 0}" update=":form:msgs,listaprodutoocfechada"/>
										</h:panelGrid>		
									</p:outputPanel>
								</p:dialog>
								
								<p:dialog widgetVar="modalAssistenciaTecnica" id="modalAssistenciaTecnica" resizable="false" header="Montadores">
									<p:outputPanel id="updAssistTec" autoUpdate="true">
										<h:panelGrid columns="2">
											<p:outputLabel for="listaMontadores" value="Montador"/>
											<p:selectManyMenu value="#{assistenciaTecnicaControl.listaMontadores}" id="listaMontadoresAT">
												<f:selectItem itemValue="" noSelectionOption="true"/>
												<f:selectItems value="#{usuarioControl.listaUsuarioMontador}" />
												<p:ajax event="change" process="@this" update="AssistenciaTecnicaAcao,listaMontadoresAT"/> 
											</p:selectManyMenu>
											<p:outputLabel value="Observações: " for="observacoesat"/>
											<p:inputTextarea id="observacoesat" value="#{ocControl.observacoesFreteMontAT}" cols="20" rows="5" maxlength="100"/>										
											<p:commandButton actionListener="#{ocControl.acaoProduto(8,assistenciaTecnicaControl.listaMontadores)}" oncomplete="modalAssistenciaTecnica.hide()" id="AssistenciaTecnicaAcao" value="Gravar Assist. Técnica" disabled="#{assistenciaTecnicaControl.listaMontadores.size() == 0}" update=":form:msgs,listaprodutoocfechada"/>
										</h:panelGrid>		
									</p:outputPanel>
								</p:dialog>
												
								<p:dialog widgetVar="modalbuscaproduto" header="Buscar Produto" resizable="false" id="modalbuscaproduto">
									<p:outputPanel id="updProduto">									
										<h:panelGrid id="dadosproduto">
											<h:panelGrid columns="3">
												<p:outputLabel for="buscaproduto" value="Código/Nome: "/>
												<p:autoComplete id="buscaproduto" value="#{ocProdutoControl.ocproduto.produto}" minQueryLength="3"
																		completeMethod="#{produtoControl.buscaProdutoCodigoNome}"											 
																		forceSelection="true"  converter="converter.ProdutoConverter"
																		var="produto" itemValue="#{produto}" itemLabel="#{produto.fornecedor.nome} - #{produto.descricao}">
													<p:ajax event="itemSelect" update="dadosproduto" process="@this" />
												</p:autoComplete>																						
												<p:commandButton value="Limpar" actionListener="#{ocProdutoControl.limparOcProduto}" update="dadosproduto" id="limparproduto" disabled="#{ocProdutoControl.ocproduto.produto.id == null}" process="@this,dadosproduto" />											
											</h:panelGrid>									
											<h:panelGrid columns="2" id="descproduto">																					
												<p:outputLabel for="codigoproduto" value="Código: " />
												<p:inputText disabled="#{ocProdutoControl.ocproduto.produto.id != null}" value="#{ocProdutoControl.ocproduto.produto.codigo}" id="codigoproduto"/>
												
												<p:outputLabel for="nomeproduto" value="Nome: " />
												<p:inputText disabled="#{ocProdutoControl.ocproduto.produto.id != null}" value="#{ocProdutoControl.ocproduto.produto.descricao}" id="nomeproduto"/>
												
												<p:outputLabel for="nomefornecedor" value="Fornecedor: " />
												<p:inputText disabled="#{ocProdutoControl.ocproduto.produto.id != null}" value="#{ocProdutoControl.ocproduto.produto.fornecedor.nome}" id="nomefornecedor" rendered="#{ocProdutoControl.ocproduto.produto.id != null}"/>
												<p:selectOneMenu value="#{ocProdutoControl.ocproduto.produto.fornecedor.id}" id="fornecedor" rendered="#{ocProdutoControl.ocproduto.produto.id == null}">
													<f:selectItem itemValue="0" itemLabel="Selecione Fornecedor" noSelectionOption="true"/>							
													<f:selectItems value="#{fornecedoresControl.getListaFornecedorCombo('')}"/>																									
												</p:selectOneMenu>
												
												<p:outputLabel for="valorsugerido" value="Valor sugerido: " />
												<p:inputText disabled="#{ocProdutoControl.ocproduto.produto.id != null}" value="#{ocProdutoControl.ocproduto.produto.valorsugerido}" id="valorsugerido">
													<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1"/>
													<p:ajax event="blur" process="@this" update="@this"/>
												</p:inputText>
												
												<p:outputLabel value="Showroom: " />
												<p:inputText disabled="true" value="#{ocProdutoControl.ocproduto.produto.showroom}" id="qtdeshowroomvis" rendered="#{ocProdutoControl.ocproduto.produto.id != null}"/>
												<p:spinner value="#{ocProdutoControl.ocproduto.produto.showroom}" required="true" id="qtdeshowroomedit" max="999" min="0" rendered="#{ocProdutoControl.ocproduto.produto.id == null}">
													<f:validateBean/>
													<f:convertNumber maxIntegerDigits="3"/>
												</p:spinner>
												
												<p:outputLabel value="Estoque: " />
												<p:inputText disabled="true" value="#{ocProdutoControl.ocproduto.produto.estoque}" id="qtdeestoquevis" rendered="#{ocProdutoControl.ocproduto.produto.id != null}"/>
												<p:spinner value="#{ocProdutoControl.ocproduto.produto.estoque}" required="true" id="qtdeestoqueedit" max="999" min="0" rendered="#{ocProdutoControl.ocproduto.produto.id == null}">
													<f:validateBean/>
													<f:convertNumber maxIntegerDigits="3"/>
												</p:spinner>
												
												<p:outputLabel value="Encomenda: " />
												<p:inputText disabled="true" value="#{ocProdutoControl.ocproduto.produto.encomenda}" id="qtdeencomendavis" rendered="#{ocProdutoControl.ocproduto.produto.id != null}"/>
												<p:spinner value="#{ocProdutoControl.ocproduto.produto.encomenda}" required="true" id="qtdeencomendaedit" max="999" min="0" rendered="#{ocProdutoControl.ocproduto.produto.id == null}">
													<f:validateBean/>
													<f:convertNumber maxIntegerDigits="3"/>
												</p:spinner>
												<p:outputLabel for="tiposaida" value="Tipo de Saída: "/>
												<p:selectOneMenu value="#{ocProdutoControl.ocproduto.tiposaida}" id="tiposaida" size="1">
													<p:ajax event="change" process="@this"/>
													<f:selectItem noSelectionOption="true" itemLabel="Escolha uma Saída"/>
													<f:selectItem itemValue="estoque" itemLabel="Estoque" itemDisabled="#{ocProdutoControl.ocproduto.produto.estoque == 0}"/>
													<f:selectItem itemValue="showroom" itemLabel="Showroom" itemDisabled="#{ocProdutoControl.ocproduto.produto.showroom == 0}" />
													<f:selectItem itemValue="encomenda" itemLabel="Encomenda" />
												</p:selectOneMenu>
												
												<p:outputLabel for="temmontagem" value="Montagem: "/>
												<p:selectBooleanCheckbox id="temmontagem" value="#{ocProdutoControl.ocproduto.produto.temMontagem}"
																	  disabled="#{ocProdutoControl.ocproduto.produto.id != null}"/>
												
												<p:outputLabel for="ehplanejado" value="Planejado: "/>
												<p:selectBooleanCheckbox id="ehplanejado" value="#{ocProdutoControl.ocproduto.produto.ehPlanejado}"
																	  	 disabled="#{ocProdutoControl.ocproduto.produto.id != null}">
													<p:ajax event="change" process="@this" update="temmontagem"/>
												</p:selectBooleanCheckbox>
																								
												<p:outputLabel for="quantidade" value="Quantidade: " />
												<p:spinner  value="#{ocProdutoControl.ocproduto.quantidade}" id="quantidade" immediate="true" min="1" max="999">
													<f:validateBean />
													<p:ajax event="change"  process="@this,valortotal,tiposaida" update="valortotal,tiposaida" />
													<p:ajax event="blur"  process="@this,valortotal,tiposaida" update="valortotal,tiposaida" />
												</p:spinner>
												
												<p:outputLabel for="valorunitario" value="Valor Unitário: " />
												<p:inputText value="#{ocProdutoControl.ocproduto.valorunitario}" id="valorunitario" immediate="true" >
													<p:ajax event="blur"  process="@this,valortotal" update="valorunitario,valortotal" />
													<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1"/>												
												</p:inputText>											
											
												<p:outputLabel for="valortotal" value="Valor Total: " />
												<p:inputText value="#{ocProdutoControl.ocproduto.valortotal}" id="valortotal">
													<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1" />		
												</p:inputText>																															
												
												<p:commandButton value="Insere Produto" actionListener="#{ocControl.adicionarProdutoOc(ocProdutoControl.ocproduto)}" 
																 process="@this,dadosproduto,valoroc" update="updLista,valoroc,:form:oc:valorfinaloc"  onclick="modalbuscaproduto.hide()"
																 action="#{ocProdutoControl.limparOcProduto}" rendered="#{ocProdutoControl.ocproduto.produto.id != null}"/>
																 
												<p:commandButton value="Insere Produto/OC"  actionListener="#{ocControl.gravarProdutoAdicionaOc(ocProdutoControl.ocproduto)}" 
																 process="@this,dadosproduto,valoroc" update="updLista,valoroc,:form:oc:valorfinaloc"  onclick="modalbuscaproduto.hide()"	
																 action="#{ocProdutoControl.limparOcProduto}" rendered="#{ocProdutoControl.ocproduto.produto.id == null}"/>
												
											</h:panelGrid>
										</h:panelGrid>
									</p:outputPanel>
								</p:dialog>
								<p:contextMenu for="listaprodutooc">
								 	<p:menuitem value="Deletar" update="listaprodutooc,valoroc,:form:msgs" icon="ui-icon-close" process="@this,listaprodutooc,valoroc,:form:oc:valorfinaloc" 
								 				actionListener="#{ocControl.removerProdutoOc(ocControl.ocproduto)}"/>
								 </p:contextMenu>
								 						 
								<p:outputPanel id="updLista">																										 
									<p:dataTable id="listaprodutooc" value="#{ocControl.oc.ocprodutos}"
									 			 var="ocproduto" rowKey="#{ocproduto.produto.id}" emptyMessage="Sem proddutos cadastrados para a OC" 
									 			 rowIndexVar="linha" editable="true" selection="#{ocControl.ocproduto}" selectionMode="single"
									 			 rendered="#{ocControl.oc.status.id == 2 or ocControl.oc.status.id == 1 or ocControl.oc.id == null}">
									 	
									 	<p:ajax event="rowEdit" listener="#{ocControl.calculaValorTotalProdutos}" update=":form:oc:valoroc,:form:oc:valorfinaloc" 
									 			process=":form:oc:valorfinaloc,listaprodutooc" />
									 									 
										<p:column headerText="Item">
								            <h:outputText value="#{linha + 1}" />
								        </p:column>
								
								        <p:column headerText="Código">
								            <h:outputText value="#{ocproduto.produto.codigo}" />
								        </p:column>
								        
								        <p:column headerText="Discriminação">
								            <h:outputText value="#{ocproduto.produto.fornecedor.nome} - #{ocproduto.produto.descricao}" />
								        </p:column>
								        
								        <p:column headerText="Tipo de Saída">
								        	<p:cellEditor id="tiposaida">
								        		<f:facet name="output" >
								        			<h:outputText value="Estoque" rendered="#{ocproduto.tiposaida == 'estoque'}" />
						        					<h:outputText value="Encomenda" rendered="#{ocproduto.tiposaida == 'encomenda'}" />
						        					<h:outputText value="Showroom" rendered="#{ocproduto.tiposaida == 'showroom'}" />
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:selectOneMenu value="#{ocproduto.tiposaida}" id="tiposaidalista" size="1" style="width: 120px;">
														<p:ajax event="change" listener="#{ocControl.calculaValorTotalProdutos}" update="tiposaida,tiposaidalista" process="@this"/>
														<f:selectItem noSelectionOption="true" itemLabel="Escolha uma Saída"/>
														<f:selectItem itemValue="estoque" itemLabel="Estoque" itemDisabled="#{ocproduto.produto.estoque == 0}"/>
														<f:selectItem itemValue="showroom" itemLabel="Showroom" itemDisabled="#{ocproduto.produto.showroom == 0}" />
														<f:selectItem itemValue="encomenda" itemLabel="Encomenda" />
													</p:selectOneMenu>
								        		</f:facet>
								        	</p:cellEditor>
								        </p:column>
								        
								        <p:column headerText="Status" rendered="#{ocControl.oc.id != null}" styleClass="status_#{oc.status.id}">							        		
							        		<h:outputText value="#{ocproduto.status.descricao}" />
								        </p:column>
								             
								        <p:column headerText="Valor Unitário">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.valorunitario}">
										        		<f:convertNumber type="currency" locale="pt_BR" maxFractionDigits="2" minFractionDigits="2" maxIntegerDigits="6" minIntegerDigits="1"/>										        												        			
										        	</h:outputText>
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:inputText value="#{ocproduto.valorunitario}" id="valorunitariolista">
														<p:ajax event="blur"  process="@this,valortotallista" update="valorunitariolista,valortotallista" listener="#{ocControl.calculaValorTotalProdutos}"/>
														<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1"/>																										
													</p:inputText>
								        		</f:facet>
								        	</p:cellEditor>            
								        </p:column>
								        
								        <p:column headerText="Quantidade">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.quantidade}" />
								        		</f:facet>
								        		<f:facet name="input">
								        		<p:spinner  value="#{ocproduto.quantidade}" id="quantidadelista" min="1" max="999">
													<f:validateBean />
													<p:ajax event="change"  process="@this,valortotallista" update="quantidadelista,valorunitariolista,valortotallista,tiposaidalista" listener="#{ocControl.calculaValorTotalProdutos}"/>
													<p:ajax event="blur"  process="@this,valortotallista" update="quantidadelista,valorunitariolista,valortotallista,tiposaidalista" listener="#{ocControl.calculaValorTotalProdutos}"/>
												</p:spinner>
								        		</f:facet>
								        	</p:cellEditor>            
								        </p:column>
								        
								        <p:column headerText="Total">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.valortotal}" id="valortotalout">
										        		<f:convertNumber type="currency" locale="pt_BR" maxFractionDigits="2" minFractionDigits="2" maxIntegerDigits="6" minIntegerDigits="1"/>
										        	</h:outputText>	
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:inputText value="#{ocproduto.valortotal}" id="valortotallista">
														<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1" />		
													</p:inputText>
								        		</f:facet>
								        	</p:cellEditor>         
								        </p:column>
								      
								        <p:column headerText="Editar" style="width: 6px;">
								        	<p:rowEditor />
								        </p:column>			        
									</p:dataTable>	
									
									<p:dataTable id="listaprodutoocfechada" value="#{ocControl.oc.ocprodutos}"
									 			 var="ocproduto" rowKey="#{ocproduto.produto.id}" emptyMessage="Sem proddutos cadastrados para a OC" 
									 			 rowIndexVar="linha" editable="true" selection="#{ocProdutoControl.listaOcProdutoAcao}" selectionMode="multiple"
									 			 rendered="#{ocControl.oc.status.id != 2 and ocControl.oc.status.id != 1 and ocControl.oc.id != null}">
									 	
									 	<p:ajax event="rowSelect" listener="#{ocControl.addProdutoAcao}" update=":form:msgs"/>
                    			  
        								<p:ajax event="rowUnselect" listener="#{ocControl.subProdutoAcao}" update=":form:msgs"/>
        								 								 
										<p:column headerText="Item">
								            <h:outputText value="#{linha + 1}" />
								        </p:column>
								
								        <p:column headerText="Código">
								            <h:outputText value="#{ocproduto.produto.codigo}" />
								        </p:column>
								        
								        <p:column headerText="Discriminação">
								            <h:outputText value="#{ocproduto.produto.fornecedor.nome} - #{ocproduto.produto.descricao}" />
								        </p:column>
								        
								        <p:column headerText="Tipo de Saída">
								        	<p:cellEditor id="tiposaida">
								        		<f:facet name="output" >
								        			<h:outputText value="Estoque" rendered="#{ocproduto.tiposaida == 'estoque'}" />
						        					<h:outputText value="Encomenda" rendered="#{ocproduto.tiposaida == 'encomenda'}" />
						        					<h:outputText value="Showroom" rendered="#{ocproduto.tiposaida == 'showroom'}" />
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:selectOneMenu value="#{ocproduto.tiposaida}" id="tiposaidalista" size="1" style="width: 120px;">
														<p:ajax event="change" listener="#{ocControl.calculaValorTotalProdutos}" update="tiposaida,tiposaidalista" process="@this"/>
														<f:selectItem noSelectionOption="true" itemLabel="Escolha uma Saída"/>
														<f:selectItem itemValue="estoque" itemLabel="Estoque" itemDisabled="#{ocproduto.produto.estoque == 0}"/>
														<f:selectItem itemValue="showroom" itemLabel="Showroom" itemDisabled="#{ocproduto.produto.showroom == 0}" />
														<f:selectItem itemValue="encomenda" itemLabel="Encomenda" />
													</p:selectOneMenu>
								        		</f:facet>
								        	</p:cellEditor>
								        </p:column>
								        
								        <p:column headerText="Status" rendered="#{ocControl.oc.id != null}" styleClass="status_#{ocproduto.status.id}">							        		
							        		<h:outputText value="#{ocproduto.status.descricao}" />
								        </p:column>
								             
								        <p:column headerText="Valor Unitário">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.valorunitario}">
										        		<f:convertNumber type="currency" locale="pt_BR" maxFractionDigits="2" minFractionDigits="2" maxIntegerDigits="6" minIntegerDigits="1"/>										        												        			
										        	</h:outputText>
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:inputText value="#{ocproduto.valorunitario}" id="valorunitariolista">
														<p:ajax event="blur"  process="@this,valortotallista" update="valorunitariolista,valortotallista" listener="#{ocControl.calculaValorTotalProdutos}"/>
														<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1"/>																										
													</p:inputText>
								        		</f:facet>
								        	</p:cellEditor>            
								        </p:column>
								        
								        <p:column headerText="Quantidade">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.quantidade}" />
								        		</f:facet>
								        		<f:facet name="input">
								        		<p:spinner  value="#{ocproduto.quantidade}" id="quantidadelista" min="1" max="999">
													<f:validateBean />
													<p:ajax event="change"  process="@this,valortotallista" update="quantidadelista,valorunitariolista,valortotallista,tiposaidalista" listener="#{ocControl.calculaValorTotalProdutos}"/>
													<p:ajax event="blur"  process="@this,valortotallista" update="quantidadelista,valorunitariolista,valortotallista,tiposaidalista" listener="#{ocControl.calculaValorTotalProdutos}"/>
												</p:spinner>
								        		</f:facet>
								        	</p:cellEditor>            
								        </p:column>
								        
								        <p:column headerText="Total">
								        	<p:cellEditor>
								        		<f:facet name="output">
								        			<h:outputText value="#{ocproduto.valortotal}" id="valortotalout">
										        		<f:convertNumber type="currency" locale="pt_BR" maxFractionDigits="2" minFractionDigits="2" maxIntegerDigits="6" minIntegerDigits="1"/>
										        	</h:outputText>	
								        		</f:facet>
								        		<f:facet name="input">
								        			<p:inputText value="#{ocproduto.valortotal}" id="valortotallista">
														<f:convertNumber locale="pt_BR" maxFractionDigits="2" maxIntegerDigits="6" minFractionDigits="2" minIntegerDigits="1" />		
													</p:inputText>
								        		</f:facet>
								        	</p:cellEditor>         
								        </p:column>								        			        
									</p:dataTable>																																	
								</p:outputPanel>								
							</p:tab>
							
							<p:tab title="Financeiro" id="financeiro">								
								<p:outputPanel id="updFinanceiro" autoUpdate="true">																								
									<h:panelGrid id="dadosfinanceiro" columns="2" columnClasses="vAlTop,vAlTop">
										<p:panel>
											<h:panelGrid columns="4">
												<p:outputLabel value="Frete: " />
												<p:inputText value="#{ocControl.oc.valorfrete}">
													<f:validateBean />
													<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="4" minFractionDigits="2"/>
													<p:ajax event="blur" process="@this" update="@this,valorfinaloc" listener="#{ocControl.calculaValorTotal}"/>
												</p:inputText>
												
												<p:outputLabel value="Tipo de Frete: " for="tipofrete"/>
												<p:selectOneMenu value="#{ocControl.oc.tipoFrete}" size="1" required="true" id="tipofrete" style="width: 100px;">
													<f:validateBean />
													<f:selectItem noSelectionOption="true" itemLabel=""/>
													<f:selectItems value="#{ocControl.listaTipoFrete}"/>
													<p:ajax event="change" process="@this" update="@this,valorfinaloc" listener="#{ocControl.calculaValorTotal}"/>
												</p:selectOneMenu>
												
												<p:outputLabel value="Montagem: " />
												<p:inputText value="#{ocControl.oc.valormontagem}">
													<f:validateBean />
													<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="4" minFractionDigits="2"/>
													<p:ajax event="blur" process="@this" update="@this,valorfinaloc" listener="#{ocControl.calculaValorTotal}"/>
												</p:inputText>
												
												<p:outputLabel value="Prazo de Entrega: " for="prazoentrega"/>
												<p:inputText value="#{ocControl.oc.prazoentrega}" rendered="false" required="true">
													<f:validateBean />
													<f:convertNumber minIntegerDigits="1" maxIntegerDigits="3"/>
													<p:ajax event="blur" process="@this" update="@this"/>
												</p:inputText>			
												<p:calendar value="#{ocControl.oc.prazoentrega}" id="prazoentrega" pattern="dd/MM/yyyy" locale="pt" required="true"/>							
											</h:panelGrid>
											<h:panelGrid columns="2" >
												<p:outputLabel for="obsoc" value="Observações: "/>
												<p:inputTextarea value="#{ocControl.oc.observacoes}" id="obsoc" rows="10" cols="50"/>
											</h:panelGrid>
											<h:panelGrid columns="2">
												<p:outputLabel for="valoroc" value="Valor: "/>
												<p:inputText value="#{ocControl.oc.valor}" id="valoroc">
													<f:validateBean />
													<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
													<p:ajax event="blur" process="@this"/>
												</p:inputText>
												
												<p:outputLabel for="valorfinanciadooc" value="Valor Financ.: "/>
												<p:inputText value="#{ocControl.oc.valorfinanciado}" id="valorfinanciadooc">
													<f:validateBean />
													<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
													<p:ajax event="blur" process="@this"/>
												</p:inputText>
												
												<p:outputLabel for="valorfinaloc" value="Valor Final: "/>
												<p:inputText value="#{ocControl.oc.valorfinal}" id="valorfinaloc">
													<f:validateBean />
													<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
													<p:ajax event="blur" process="@this" update="@this,updSelecaoCondicao"/>																																							 
												</p:inputText>
												<p:message for="valorfinaloc"/>
											</h:panelGrid>
										</p:panel>
										<p:panel rendered="#{sessionScope.UsuarioLogado.perfil.id != 2 and (ocControl.oc.status.id == 2 or ocControl.oc.status.id == 1)}">
											<p:panel rendered="#{not ocControl.habilitaCondicoesPagamento()}">											
												<p:outputPanel id="updSelecaoCondicao">
													<h:panelGrid columns="2" id="formapagamentodet">
														<p:outputLabel for="formapagamento" value="Forma de Pagamento: "/>
														<p:selectOneMenu id="formapagamento" value="#{ocControl.pagamento.condicoesPagamento.formapagamento.id}">						
															<f:selectItem itemLabel="Selecione Forma de Pagamento" itemValue=""/>
															<f:selectItems value="#{formaPagamentoControl.getListaFormaPagamentoCombo('')}"/>
															<p:ajax event="change" update="formapagamento,condicoespagamento,gravarformapagamento" process="formapagamento" listener="#{ocControl.defineFormaPagamento}"/>
														</p:selectOneMenu>
																									
														<p:outputLabel for="condicoespagamento" value="Condição de Pagamento: "/>
														<p:selectOneMenu id="condicoespagamento" value="#{ocControl.pagamento.condicoesPagamento.id}">
															<f:selectItem itemLabel="Selecione Condição" itemValue=""/>
															<f:selectItems value="#{condicoesPagamentoControl.carregaCondicoesPagamentoPorFormaPagamento(ocControl.pagamento.condicoesPagamento.formapagamento.id)}"/>
															<p:ajax event="change" process="@this" listener="#{ocControl.defineCondicoesPagamento}" update="banco,mesmocliente"/>
														</p:selectOneMenu>
														
														<p:outputLabel value="Banco: " for="banco" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4}" />
														<p:selectOneMenu id="banco" value="#{ocControl.pagamento.banco.id}" required="true" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4}">
															<f:selectItem itemLabel="Selecione Banco" itemValue=""/>
															<f:selectItems value="#{bancoControl.listaBancoCombo('')}"/>
															<p:ajax event="change" process="@this" update="condicoespagamento,gravarformapagamento"/>
														</p:selectOneMenu>
														
														<p:outputLabel value="Mesmo Cliente?: " for="mesmocliente" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4}" />
														<p:selectBooleanCheckbox id="mesmocliente" value="#{ocControl.ehClienteChequeOc}" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4}">
															<p:ajax process="@this" update="clientepagador" />
														</p:selectBooleanCheckbox>
														
														<p:outputLabel value="Cliente Pagador: " for="clientepagador" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4 and !ocControl.ehClienteChequeOc}" />
														<p:selectOneMenu id="clientepagador" value="#{ocControl.pagamento.cliente.id}" required="true" rendered="#{ocControl.pagamento.condicoesPagamento.formapagamento.id == 4 and !ocControl.ehClienteChequeOc}">
															<f:selectItem itemLabel="Selecione Banco" itemValue=""/>
															<f:selectItems value="#{clienteControl.listaClienteCombo()}"/>
															<p:ajax event="change" process="@this" />
														</p:selectOneMenu>
														
														<p:outputLabel for="valorcondicoespagamento" value="Valor: "/>																											
														<p:inputText value="#{ocControl.pagamento.valor}" id="valorcondicoespagamento">															
															<f:validateBean />
															<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
															<p:ajax event="blur" process="@this" update="valorcondicoespagamento,gravarformapagamento"/>
														</p:inputText>
														<p:commandButton id="gravarformapagamento" value="Adicionar Forma Pagamento" update="updFormaPagamento,updSelecaoCondicao,:form:msgs,gravarpgto" process="@this"
																		actionListener="#{ocControl.gravaFormaPagamentoOc()}" disabled="#{ocControl.pagamento.condicoesPagamento.id == null or ocControl.pagamento.valor == 0}">														
														</p:commandButton>
													</h:panelGrid>		
												</p:outputPanel>
											</p:panel>
											<p:panel>
												<p:contextMenu for="tabelapagamento">
													<p:menuitem value="Deletar" update="updFormaPagamento,updSelecaoCondicao" icon="ui-icon-close" process="@this,tabelapagamento"
								 								actionListener="#{ocControl.removeCondicoesPagamento(ocControl.pagamento)}"/>
												</p:contextMenu>
												<p:outputPanel id="updFormaPagamento">
													<p:dataTable id="tabelapagamento" value="#{ocControl.oc.pagamentos}" var="pagamento"
																 selectionMode="single" selection="#{ocControl.pagamento}" rowKey="#{pagamento.condicoesPagamento.id}"
																 emptyMessage="Sem formas de pagamento lançada!">														
														<p:column headerText="Forma de Pagamento">
														<h:outputText value="#{pagamento.condicoesPagamento.formapagamento.nome}" />
														</p:column>
														<p:column headerText="Condição">
															<h:outputText value="#{pagamento.condicoesPagamento.nome}"/>
														</p:column>
														<p:column headerText="Valor">
															<h:outputText value="#{pagamento.valor}">
																<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
															</h:outputText>
														</p:column>														
													</p:dataTable>
													<br />
													<p:commandButton value="Liberar Pagamento" rendered="#{ocControl.habilitaCondicoesPagamento()}" id="gravarpgto"
																		action="#{ocControl.liberarPagamento}" ajax="false"/>													
												</p:outputPanel>																																		
											</p:panel>										
										</p:panel>
										<p:panel rendered="#{ocControl.oc.status.id != 1 and ocControl.oc.status.id != 2 and ocControl.oc.status.id != 10}">
											<p:dataTable id="tabelapagamento_vis" value="#{ocControl.oc.pagamentos}" var="pagamento"
														 selectionMode="single" selection="#{ocControl.pagamento}" rowKey="#{pagamento.condicoesPagamento.id}"
														 emptyMessage="Sem formas de pagamento lançada!">														
												<f:facet name="header">
													Pagamento
												</f:facet>
												<p:column headerText="Forma de Pagamento">
												<h:outputText value="#{pagamento.condicoesPagamento.formapagamento.nome}" />
												</p:column>
												<p:column headerText="Condição">
													<h:outputText value="#{pagamento.condicoesPagamento.nome}"/>
												</p:column>
												<p:column headerText="Valor">
													<h:outputText value="#{pagamento.valor}">
														<f:convertNumber maxFractionDigits="2" minIntegerDigits="1" maxIntegerDigits="6" minFractionDigits="2"/>
													</h:outputText>
												</p:column>														
											</p:dataTable>
										</p:panel>
									</h:panelGrid>
								</p:outputPanel>
							</p:tab>
						</p:tabView>
				</p:panel>				
			</h:form>			
		</ui:define>
		<ui:define name="rodape">
			<p:panel header="Descritivo Tela" styleClass="rodape">
	    		<p:outputLabel value="Tela para cadastro e edição de OC." styleClass="rodape_esquerda"/>
	    		<p:outputLabel value="cadastraoc.jsf" styleClass="rodape_direita"/>
	    	</p:panel>
		</ui:define>
	</ui:composition>
</html>